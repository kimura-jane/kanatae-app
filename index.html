<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>ãŠã«ãã‚Šå±‹ã‹ãªãŸã‘</title>

  <meta name="description" content="ãŠã«ãã‚Šå±‹ã‹ãªãŸã‘ã®å‡ºåº—ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ»ãƒãƒƒãƒ—ãƒ»ã‚¯ãƒ¼ãƒãƒ³">
  <meta name="theme-color" content="#f5a623">

  <!-- iOS PWAã£ã½ãã™ã‚‹ï¼ˆä»»æ„ã ã‘ã©å…¥ã‚Œã¨ãï¼‰ -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="./onigiriya_kanatake_192.png">

  <!-- OGPï¼ˆSNSç”¨ã€‚çµ¶å¯¾URLã®æ–¹ãŒç¢ºå®Ÿã ãŒä»Šã¯ç›¸å¯¾ã§ã‚‚OKï¼‰ -->
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="ãŠã«ãã‚Šå±‹ã‹ãªãŸã‘">
  <meta property="og:title" content="ãŠã«ãã‚Šå±‹ã‹ãªãŸã‘">
  <meta property="og:description" content="å‡ºåº—ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ»ãƒãƒƒãƒ—ãƒ»ã‚¯ãƒ¼ãƒãƒ³">
  <meta property="og:image" content="./onigiriya_kanatake_512.png">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>

  <link rel="stylesheet" href="./style.css">
  <script src="./spots.js" defer></script>
  <script src="./spots-all.js" defer></script>
</head>

<body>
  <div class="app">
    <header class="header">
      <h1>
        <img src="./icon.png" alt="" class="header-icon">
        ãŠã«ãã‚Šå±‹ã‹ãªãŸã‘
      </h1>
    </header>

    <nav class="tab-nav">
      <button class="tab-btn active" data-tab="calendar">ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</button>
      <button class="tab-btn" data-tab="map">ğŸ“ ãƒãƒƒãƒ—</button>
      <button class="tab-btn" data-tab="menu">ğŸ™ ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>
      <button class="tab-btn" data-tab="coupon">ğŸ« ã‚¯ãƒ¼ãƒãƒ³</button>
    </nav>

    <main class="tab-content">
      <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¿ãƒ– -->
      <section class="tab-pane active" id="calendar">
        <div class="calendar">
          <div class="calendar-header">
            <button class="calendar-nav" id="prevMonth">â—€</button>
            <h2 class="calendar-title" id="calendarTitle">2025å¹´12æœˆ</h2>
            <button class="calendar-nav" id="nextMonth">â–¶</button>
          </div>
          <div class="calendar-grid" id="calendarGrid"></div>
        </div>
      </section>

      <!-- ãƒãƒƒãƒ—ã‚¿ãƒ– -->
      <section class="tab-pane" id="map-pane">
        <div id="map"></div>
        <section class="spot-card" id="listCard">
          <p class="spot-title">å‡ºåº—ãƒªã‚¹ãƒˆï¼ˆã‚¿ãƒƒãƒ—ã§åœ°å›³ï¼‰</p>
          <ol class="spot-list" id="spotList"></ol>
        </section>
      </section>

      <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¿ãƒ– -->
      <section class="tab-pane" id="menu">
        <div class="menu-container">
          <img src="./IMG_7605.jpeg" alt="ãŠã«ãã‚Šå±‹ã‹ãªãŸã‘ ãƒ¡ãƒ‹ãƒ¥ãƒ¼" class="menu-image">
        </div>
      </section>

      <!-- ã‚¯ãƒ¼ãƒãƒ³ã‚¿ãƒ– -->
      <section class="tab-pane" id="coupon">
        <div class="coupon">
          <img src="./icon.png" alt="ã‹ãªãŸã‘" class="coupon-icon">
          <h2 class="coupon-title">ã‚¹ãƒã‚¤ãƒ«ã‚¯ãƒ¼ãƒãƒ³</h2>
          <p class="coupon-desc">ã“ã®ç”»é¢ã‚’åº—ä¸»ã«è¦‹ã›ã¦ã­</p>
          <div class="coupon-card">
            <p class="coupon-label">ç‰¹å…¸</p>
            <p class="coupon-value">ğŸ˜Š åº—ä¸»ã®ç¬‘é¡”</p>
          </div>
          <p class="coupon-note">â€» ä½•åº¦ã§ã‚‚ä½¿ãˆã¾ã™</p>

          <!-- é€šçŸ¥ -->
          <button id="pushBtn" class="push-btn" type="button">ğŸ”” é€šçŸ¥ã‚’å—ã‘å–ã‚‹</button>
          <p id="pushStatus" class="push-status">ï¼ˆæœªç™»éŒ²ï¼‰</p>
        </div>
      </section>
    </main>
  </div>

  <!-- ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-overlay" id="modal">
    <div class="modal">
      <p class="modal-date" id="modalDate"></p>
      <h3 class="modal-title" id="modalTitle"></h3>
      <p class="modal-time" id="modalTime"></p>
      <a class="modal-btn" id="modalMap" href="#" target="_blank">Googleãƒãƒƒãƒ—ã§é–‹ã</a>
      <button class="modal-btn modal-close" id="modalClose">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <script>
    // =========================
    // è¨­å®šï¼ˆã“ã“ã ã‘ãŠå‰ã®ç’°å¢ƒã«åˆã‚ã›ã‚‹ï¼‰
    // =========================
    // Cloudflare Workerï¼ˆPushç”¨ã®APIï¼‰: ãŠå‰ã®å®ŸURLã«åˆã‚ã›ã¦
    const PUSH_API_BASE = "https://<ãŠå‰ã®workerã®URL>"; // ä¾‹: https://kanatake-push.xxx.workers.dev

    // =========================
    // UI å…±é€š
    // =========================
    const $status = document.getElementById("pushStatus");
    const $pushBtn = document.getElementById("pushBtn");

    function setStatus(msg, isError = false) {
      $status.textContent = msg;
      $status.style.color = isError ? "#c00" : "";
    }

    // =========================
    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    // =========================
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabPanes = document.querySelectorAll('.tab-pane');
    let mapInitialized = false;
    let mapInstance = null;
    let markersArray = [];

    tabBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const tabId = btn.dataset.tab;

        tabBtns.forEach(b => b.classList.remove('active'));
        tabPanes.forEach(p => p.classList.remove('active'));

        btn.classList.add('active');

        if (tabId === 'map') {
          document.getElementById('map-pane').classList.add('active');
        } else {
          document.getElementById(tabId).classList.add('active');
        }

        if (tabId === 'map' && !mapInitialized) {
          initMap();
          mapInitialized = true;
        }
        if (tabId === 'map' && mapInstance) {
          setTimeout(() => mapInstance.invalidateSize(), 100);
        }
      });
    });

    // =========================
    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆspots-all.jsï¼‰
    // =========================
    let currentYear = 2025;
    let currentMonth = 12;

    function getEventsForMonth(year, month) {
      const spots = window.spotsAll || [];
      const events = {};
      spots.forEach(spot => {
        const match = spot.date.match(/(\d+)\/(\d+)/);
        if (match) {
          const m = parseInt(match[1]);
          const d = parseInt(match[2]);
          if (m === month) {
            if (!events[d]) events[d] = [];
            events[d].push(spot);
          }
        }
      });
      return events;
    }

    function getShortName(name) {
      const shortcuts = {
        'å·å£ã•ãã‚‰ç—…é™¢': 'ã•ãã‚‰ç—…é™¢',
        'ç¨å”å¤§å­¦ è‰åŠ ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹': 'ç¨å”å¤§å­¦',
        'ã•ã„ãŸã¾å¸‚å½¹æ‰€ æµ¦å’Œæœ¬åºèˆ': 'ã•ã„ãŸã¾å¸‚å½¹æ‰€',
        'å°ã•ãªæ£®ã®å®¶ å–æ‰‹æ±': 'æ£®ã®å®¶å–æ‰‹',
        'å°ã•ãªæ£®ã®å®¶ å–æ‰‹ç±³ãƒäº•': 'æ£®ã®å®¶å–æ‰‹',
        'å°ã•ãªæ£®ã®å®¶ ã•ã„ãŸã¾ä¸ƒé‡Œ': 'æ£®ã®å®¶ä¸ƒé‡Œ',
        'å°ã•ãªæ£®ã®å®¶ è¶³ç«‹è¥¿ä¿æœ¨é–“': 'æ£®ã®å®¶è¶³ç«‹',
        'æ±Ÿæˆ¸ONIGIRIç¥­ã‚Šï¼ˆãŠå°å ´ï¼‰': 'ãŠå°å ´',
        'ãƒ€ã‚¤ãƒŠãƒ æˆ¸ãƒ¶å´åº—': 'ãƒ€ã‚¤ãƒŠãƒ ',
        'ä¿è­·çŠ¬è­²æ¸¡ä¼šï¼ˆç›®é»’ï¼‰': 'ç›®é»’è­²æ¸¡ä¼š',
        'æ‰ä¸¦åŒº ã“ã©ã‚‚æ”¯æ´': 'æ‰ä¸¦ã“ã©ã‚‚',
        'ç«‹æ•™å¤§å­¦ æ± è¢‹ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹': 'ç«‹æ•™å¤§å­¦',
        'ã‹ãªãŸã‘ã‚µãƒ³ã‚¿ï¼ˆèŠ±æ —å­è‚²ã¦ã²ã‚ã°ï¼‰': 'ã‚µãƒ³ã‚¿ğŸ…',
        'æŸã®è‘‰ T-SITE': 'æŸã®è‘‰',
        'è•¨å¸‚å½¹æ‰€': 'è•¨å¸‚å½¹æ‰€',
        'åŸ¼ç‰æ±èŒçŸ­æœŸå¤§å­¦': 'æ±èŒçŸ­å¤§',
        'ãƒ‰ãƒ©ãƒ ã®é‡Œ æ„Ÿè¬ç¥­': 'ãƒ‰ãƒ©ãƒ ã®é‡Œ',
        'éƒ½ç«‹äº€æˆ¸ä¸­å¤®å…¬åœ’': 'äº€æˆ¸å…¬åœ’',
        'ä¹…å–œç·åˆæ–‡åŒ–ä¼šé¤¨': 'ä¹…å–œæ–‡åŒ–ä¼šé¤¨',
        'en market vol.5ï¼ˆå®ˆè°·ä½å®…å…¬åœ’ï¼‰': 'å®ˆè°·ãƒãƒ«ã‚·ã‚§',
        'è‘›è¥¿è‡¨æµ·å…¬åœ’': 'è‘›è¥¿è‡¨æµ·',
        'è–è·¯åŠ å›½éš›å¤§å­¦': 'è–è·¯åŠ å¤§å­¦',
        'ã„ã¡ã‹ã‚ã”ã¡ãã†ãƒãƒ«ã‚·ã‚§': 'å¸‚å·ãƒãƒ«ã‚·ã‚§',
        'å…¬åœ’ãƒ•ã‚§ã‚¹ã‚¿ å…‰ãŒä¸˜å…¬åœ’': 'å…‰ãŒä¸˜å…¬åœ’',
        'ã‚¯ãƒªã‚¹ãƒã‚¹ãƒãƒ¼ã‚±ãƒƒãƒˆï¼ˆä¸‹åŒ—ç·šè·¯è¡—ï¼‰': 'ä¸‹åŒ—ãƒãƒ¼ã‚±ãƒƒãƒˆ',
        'æ°´å…ƒå…¬åœ’': 'æ°´å…ƒå…¬åœ’',
        'CoCo Nico Marcheï¼ˆæ±æ­¦å‹•ç‰©å…¬åœ’å‰ï¼‰': 'ã‚³ã‚³ãƒ‹ã‚³',
        'ã‚·ãƒ£ãƒªã‚¨æœéœ ã‚°ãƒ©ãƒ³ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰': 'æœéœ',
        'æ±äº¬éƒ½ç«‹å¤§å­¦ è’å·ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹': 'éƒ½ç«‹å¤§è’å·',
        'ç¬¬48å› æˆ¸ç”°ãƒœãƒ¼ãƒˆå¤§è³': 'æˆ¸ç”°ãƒœãƒ¼ãƒˆ',
        'ãƒ€ã‚¤ãƒãƒ„ãƒãƒ«ã‚·ã‚§ ç«¹ãƒå¡š': 'ãƒ€ã‚¤ãƒãƒ„ç«¹ãƒå¡š',
        'éƒ½ç«‹å¤§å³¶å°æ¾å·å…¬åœ’': 'å¤§å³¶å°æ¾å·',
        'å“å·åŒºå½¹æ‰€ ç·åˆåºèˆ': 'å“å·åŒºå½¹æ‰€',
        'æ¸…æ°´å…¬åœ’': 'æ¸…æ°´å…¬åœ’',
        'ã‚¢ãƒªã‚ªä¸Šå°¾ ã¾ã¤ã‚Š': 'ã‚¢ãƒªã‚ªä¸Šå°¾',
        'T.F.P. ç¥­ã‚Šï¼ˆã‚»ãƒŠãƒªã‚ªãƒã‚¦ã‚¹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä¸‰éƒ·ï¼‰': 'TFPä¸‰éƒ·',
        'æ ¹éƒ·è§’æ „å›£åœ° ç§‹ã¾ã¤ã‚Š': 'æ ¹éƒ·ç§‹ã¾ã¤ã‚Š',
        'ã•ã„ãŸã¾å¸‚å­ã©ã‚‚å®¶åº­ç·åˆã‚»ãƒ³ã‚¿ãƒ¼': 'ã“ã©ã‚‚å®¶åº­C',
        'ã«ãŠã©ã‚Šãƒ‘ãƒ¼ã‚¯ãƒ•ã‚§ã‚¹ï¼ˆä¸‰éƒ·ä¸­å¤®ï¼‰': 'ã«ãŠã©ã‚Š',
        'é£Ÿã¨ç’°å¢ƒãƒ»ã“ã©ã‚‚ã§ã¤ãã‚‹æœªæ¥ï¼ˆæˆ¸ç”°é§…å‰ï¼‰': 'æˆ¸ç”°é§…å‰',
        'ä¸Šé‡æ©è³œå…¬åœ’': 'ä¸Šé‡å…¬åœ’',
        'å›½ç«‹ä»£ã€…æœ¨ç«¶æŠ€å ´ ç¬¬äºŒä½“è‚²é¤¨': 'ä»£ã€…æœ¨'
      };
      return shortcuts[name] || name.substring(0, 6);
    }

    function renderCalendar() {
      const title = document.getElementById('calendarTitle');
      const grid = document.getElementById('calendarGrid');

      title.textContent = `${currentYear}å¹´${currentMonth}æœˆ`;

      const firstDay = new Date(currentYear, currentMonth - 1, 1);
      const lastDay = new Date(currentYear, currentMonth, 0);
      const daysInMonth = lastDay.getDate();
      const startDow = firstDay.getDay();

      const events = getEventsForMonth(currentYear, currentMonth);
      const today = new Date();
      const isCurrentMonth = today.getFullYear() === currentYear && today.getMonth() + 1 === currentMonth;
      const todayDate = today.getDate();

      let html = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'].map(d => `<div class="calendar-dow">${d}</div>`).join('');

      for (let i = 0; i < startDow; i++) html += '<div class="calendar-day empty"></div>';

      for (let d = 1; d <= daysInMonth; d++) {
        const hasEvent = events[d] && events[d].length > 0;
        const isToday = isCurrentMonth && d === todayDate;

        let classes = 'calendar-day';
        if (hasEvent) classes += ' has-event';
        if (isToday) classes += ' today';

        const placeName = hasEvent ? `<div class="calendar-place">${getShortName(events[d][0].name)}</div>` : '';

        html += `<div class="${classes}" data-day="${d}">
          <span class="calendar-date">${d}</span>
          ${placeName}
        </div>`;
      }

      grid.innerHTML = html;

      grid.querySelectorAll('.calendar-day.has-event').forEach(el => {
        el.addEventListener('click', () => {
          const day = parseInt(el.dataset.day);
          showEventModal(day, events[day]);
        });
      });
    }

    function showEventModal(day, eventList) {
      const modal = document.getElementById('modal');
      const event = eventList[0];

      document.getElementById('modalDate').textContent = `${currentMonth}æœˆ${day}æ—¥`;
      document.getElementById('modalTitle').textContent = event.name;
      document.getElementById('modalTime').textContent = event.time || 'æ™‚é–“æœªå®š';

      const mapLink = document.getElementById('modalMap');
      if (event.lat && event.lng) {
        mapLink.href = `https://www.google.com/maps?q=${event.lat},${event.lng}`;
        mapLink.style.display = 'block';
      } else {
        mapLink.style.display = 'none';
      }

      modal.classList.add('active');
    }

    document.getElementById('modal').addEventListener('click', e => {
      if (e.target.id === 'modal' || e.target.id === 'modalClose') {
        document.getElementById('modal').classList.remove('active');
      }
    });

    document.getElementById('prevMonth').addEventListener('click', () => {
      currentMonth--;
      if (currentMonth < 1) { currentMonth = 12; currentYear--; }
      renderCalendar();
    });

    document.getElementById('nextMonth').addEventListener('click', () => {
      currentMonth++;
      if (currentMonth > 12) { currentMonth = 1; currentYear++; }
      renderCalendar();
    });

    // =========================
    // ãƒãƒƒãƒ—ï¼ˆspots.jsï¼‰
    // =========================
    function initMap() {
      mapInstance = L.map('map').setView([35.75, 139.75], 10);

      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: 'Â© OSM Â© CARTO'
      }).addTo(mapInstance);

      const icon = L.icon({
        iconUrl: './icon.png',
        iconSize: [44, 44],
        iconAnchor: [22, 32],
        popupAnchor: [0, -28]
      });

      const spots = window.spots || [];
      const list = document.getElementById('spotList');
      list.innerHTML = "";

      spots.forEach((s, i) => {
        if (s.lat && s.lng) {
          const m = L.marker([s.lat, s.lng], { icon })
            .addTo(mapInstance)
            .bindPopup(
              `<strong>${s.name}</strong><br>${s.date}${s.time ? ' ãƒ» ' + s.time : ''}<br>` +
              `<a href="https://www.google.com/maps?q=${s.lat},${s.lng}" target="_blank" rel="noopener">Googleãƒãƒƒãƒ—ã§é–‹ã</a>`
            );
          markersArray[i] = m;
        }

        const li = document.createElement('li');
        li.innerHTML = `<span class="spot-name">${s.name}</span> <span class="badge">${s.date}</span>`;
        li.addEventListener('click', () => {
          if (markersArray[i]) {
            mapInstance.setView(markersArray[i].getLatLng(), 14, { animate: true });
            markersArray[i].openPopup();
          }
        });
        list.appendChild(li);
      });

      const existing = markersArray.filter(Boolean);
      if (existing.length) mapInstance.fitBounds(L.featureGroup(existing).getBounds().pad(0.15));
    }

    // =========================
    // Pushé€šçŸ¥ï¼ˆé‡è¦ï¼šiPhoneã¯ãƒ›ãƒ¼ãƒ ç”»é¢PWAã˜ã‚ƒãªã„ã¨åŸºæœ¬ç„¡ç†ï¼‰
    // =========================
    function isStandalone() {
      return window.matchMedia && window.matchMedia("(display-mode: standalone)").matches;
    }

    function urlBase64ToUint8Array(base64String) {
      const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
      const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
      const rawData = atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
      return outputArray;
    }

    async function registerSW() {
      if (!("serviceWorker" in navigator)) throw new Error("Service Workeréå¯¾å¿œ");
      // scopeã¯ ./ ã«å›ºå®šï¼ˆ/kanatae-app/ é…ä¸‹ã§å®‰å®šã•ã›ã‚‹ï¼‰
      await navigator.serviceWorker.register("./sw.js", { scope: "./" });
      return await navigator.serviceWorker.ready;
    }

    async function fetchVapidPublicKey() {
      const res = await fetch(`${PUSH_API_BASE}/vapidPublicKey`, { mode: "cors" });
      if (!res.ok) throw new Error("VAPID_PUBLIC_KEY å–å¾—å¤±æ•—");
      const data = await res.json();
      if (!data || !data.publicKey) throw new Error("VAPID_PUBLIC_KEY æœªè¨­å®š");
      return data.publicKey;
    }

    async function upsertSubscription(sub) {
      const res = await fetch(`${PUSH_API_BASE}/subs/upsert`, {
        method: "POST",
        mode: "cors",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({ subscription: sub })
      });
      if (!res.ok) throw new Error("ã‚µãƒ¼ãƒãƒ¼ä¿å­˜å¤±æ•—");
      return true;
    }

    async function initPushUI() {
      try {
        // iPhoneå¯¾ç­–ï¼šSafariã‚¿ãƒ–ã§é–‹ã„ã¦ã‚‹ã ã‘ãªã‚‰è­¦å‘Š
        // iOSã¯ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ãŸWebã‚¢ãƒ—ãƒªã®ã¿Web Pushå¯¾å¿œ  [oai_citation:1â€¡WebKit](https://webkit.org/blog/13878/web-push-for-web-apps-on-ios-and-ipados/)
        if (/(iPhone|iPad|iPod)/i.test(navigator.userAgent) && !isStandalone()) {
          setStatus("iPhoneã¯ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã—ãŸã‚¢ãƒ—ãƒªã‹ã‚‰é–‹ã‹ãªã„ã¨é€šçŸ¥ã¯å‹•ã‹ãªã„", true);
          return;
        }

        const reg = await registerSW();

        if (!("Notification" in window)) {
          setStatus("Notification API éå¯¾å¿œ", true);
          return;
        }
        if (!("PushManager" in window) || !reg.pushManager) {
          setStatus("ã“ã®ç’°å¢ƒã¯Pushæœªå¯¾å¿œï¼ˆiPhoneã¯ãƒ›ãƒ¼ãƒ ç”»é¢PWAã®ã¿å¯¾å¿œï¼‰", true);
          return;
        }

        // æ—¢å­˜è³¼èª­ãƒã‚§ãƒƒã‚¯
        const existing = await reg.pushManager.getSubscription();
        if (existing) {
          setStatus("âœ… é€šçŸ¥ã¯ç™»éŒ²æ¸ˆã¿");
          return;
        }

        setStatus("ï¼ˆæœªç™»éŒ²ï¼‰");
      } catch (e) {
        setStatus(`âœ– ${e.message}`, true);
      }
    }

    $pushBtn.addEventListener("click", async () => {
      $pushBtn.disabled = true;
      try {
        if (!PUSH_API_BASE || PUSH_API_BASE.includes("<ãŠå‰ã®worker")) {
          throw new Error("PUSH_API_BASE ã‚’è¨­å®šã—ã¦");
        }

        const reg = await registerSW();

        // æ¨©é™è¦æ±‚ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã®ä¸­ã§ã‚„ã‚‹å¿…è¦ãŒã‚ã‚‹ï¼‰
        const perm = await Notification.requestPermission();
        if (perm !== "granted") throw new Error("é€šçŸ¥ãŒè¨±å¯ã•ã‚Œãªã‹ã£ãŸ");

        const publicKey = await fetchVapidPublicKey();
        const applicationServerKey = urlBase64ToUint8Array(publicKey);

        const sub = await reg.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey
        });

        await upsertSubscription(sub);

        setStatus("âœ… é€šçŸ¥ã‚’ç™»éŒ²ã—ãŸ");
      } catch (e) {
        setStatus(`âœ– ${e.message}`, true);
      } finally {
        $pushBtn.disabled = false;
      }
    });

    // åˆæœŸåŒ–
    document.addEventListener("DOMContentLoaded", () => {
      renderCalendar();
      initPushUI();
    });
  </script>
</body>
</html>
